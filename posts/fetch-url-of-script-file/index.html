<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>获取 JavaScript 脚本文件路径 - 欧雷流</title><meta name="description" content="不走寻常路"><link rel="author" href="http://ourai.ws/"><link rel="icon" href="/assets/favicon-d770cf1b4a3a03cd5bac1dde4e2e413f.ico"><link rel="stylesheet" href="/assets/global-c017bcef7ea2afa63857411ff4ca6f8e.css"><link rel="stylesheet" href="/assets/share-56a633c78644feaa49a3df0449290af5.css"><link rel="stylesheet" href="/assets/pages/common-05b7f6ad71682a2045a3a25c8a90b6ea.css"> <script src="/assets/global-6d5e42c77c3a921431d6341f6f4e7f96.js"></script><!--[if lt IE 9]><script src="/assets/support_ie8-f9109bd900850d4f4fbac70091ae986d.js"></script><![endif]--></head><body itemscope itemtype="http://schema.org/WebPage"> <nav class="Page-navs"><ul><li><a href="/">首页</a></li><li><a href="/posts/">文章</a></li><li><a href="/about/">关于</a></li></ul> </nav> <header class="Page-header container sr-only"><div><h1>欧雷流</h1><p>不走寻常路</p></div> </header> <main> <article class="container"> <header><h1>获取 JavaScript 脚本文件路径</h1><p><time datetime="2013-08-22 00:00:00 +0800">2013-08-22 00:00:00</time>发布</p> </header><div class="Article-content col-md-9"><p>在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 <a href="http://seajs.org">Sea.js</a> 等 Module Loader 就会用到。</p><p>目前常被用到的有以下几种方式，它们有各自的优缺点。</p><h2 class="heading" id="script-">script 标签</h2><p>通过获取最后一个<code>&lt;script&gt;</code>标签的<code>src</code>属性来得到脚本文件的 URL。这种方式的关键点是<strong>正在执行的语句所在的 JS 文件是“当时最后的 JS 文件”</strong>。Sea.js 中就是用的此方法。</p><p>正因如此，瓶颈也在这里。这种方式只能在同一个文件中即时执行才有效，不能延迟执行及写成通用的 method 供其他地方调用，否则获取到的不一定是哪个 JS 文件的 URL 了。不过这种方式的优点就是能够兼容各个浏览器。</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">scripts</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">];</span>

  <span class="k">return</span> <span class="nx">script</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">?</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">:</span>
    <span class="c1">// hack for IE8-</span>
    <span class="c1">// see http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span> <span class="s2">"src"</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">();</span></code></pre></div><h2 class="heading" id="section">捕获异常</h2><p>这是一个从<a href="http://www.cnblogs.com/rubylouvre/archive/2010/04/06/1705817.html">司徒正美的博文</a>中看到的较为“聪明”的方法，利用了 exception 信息中会带有出错文件及位置的特点来获取。</p><p>这种方式可以写为一个通用的 method，但其还是有两个较为严重的缺陷：</p><ol><li>兼容性差，IE 和 Opera 基本都被排挤在外</li><li>在调用时必须在回调函数中抛出异常</li></ol><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">(</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">"function"</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Firefox</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Safari</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Opera 9</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/\(\) in\s+(.*?\:\/\/\S+)/m</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="c1">// Chrome 4+/IE 10+</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/((http|file)\:\/{2,3}\S+\/\S+\.[a-z0-9]+)/i</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span><span class="s1">''</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// must throw an exception</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span> <span class="s2">"WTF!!!"</span> <span class="p">);</span>
    <span class="p">});</span></code></pre></div></div> <footer class="col-md-3"><div class="Article-meta"><p><a href="/about/" class="Author-link--withAvatar"><img src="/assets/avatars/ourai-100px-c12530e270d0aa48f4bddc067ec66ce0.jpg"></a><a href="/about/" class="Author-link">欧雷</a>发表于<br>Web 开发</p><div id="supportAuthor"><p>如果您觉得文章内容有所帮助，请随意打赏。您的支持将鼓励作者继续创作！</p><ul><li><img src="/assets/qrcodes/pay/alipay/ourai-95f3f9a7ad63ae0b2c12ae8f7da284bb.jpg"></li><li><img src="/assets/qrcodes/pay/wechat/ourai-dbfd38193e96f087bfb12eb18df33f45.jpg"></li></ul></div></div><div class="Article-license"><p>本文采用知识共享<a href="http://creativecommons.org/licenses/by-nc/3.0/cn/" target="_blank">署名-非商业性使用 3.0 中国大陆</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p></div><div class="Article-share social-share" data-sites="wechat,qzone,weibo,twitter"></div> </footer> </article><div class="container"><div class="row"><div id="disqus_thread" class="col-md-9"></div></div></div> <script>var disqus_shortname="ourairyu";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </main> <script src="/assets/pages/post-2cdbe0399dd11a1b279a1d6a4c42d7f3.js"></script></body></html>