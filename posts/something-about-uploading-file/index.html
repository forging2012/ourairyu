<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>上传文件这件事，蛋疼何止一点点！ - 欧雷流</title><meta name="description" content="不走寻常路"><link type="application/atom+xml" rel="alternate" href="http://ourai.ws/atom.xml" title="欧雷流"/><link type="application/rss+xml" rel="alternate" href="http://ourai.ws/rss.xml" title="欧雷流"><link rel="author" href="http://ourai.ws/"><link rel="icon" href="/assets/favicon-d770cf1b4a3a03cd5bac1dde4e2e413f.ico"><link rel="stylesheet" href="/assets/global-a600a3b8cf7b3ebf5f2e38a52e0189a2.css"><link rel="stylesheet" href="/assets/share-56a633c78644feaa49a3df0449290af5.css"><link rel="stylesheet" href="/assets/pages/common-bbec6abc886327b6c805887c34141a54.css"> <script src="/assets/global-6d5e42c77c3a921431d6341f6f4e7f96.js"></script><!--[if lt IE 9]><script src="/assets/support_ie8-f9109bd900850d4f4fbac70091ae986d.js"></script><![endif]--></head><body class="Page" itemscope itemtype="http://schema.org/WebPage"> <nav class="Page-navs"><ul><li><a href="/">首页</a></li><li><a href="/posts/">文章</a></li><li><a href="/about/">关于</a></li></ul> </nav> <header class="Page-header container sr-only"><div><h1>欧雷流</h1><p>不走寻常路</p></div> </header> <main class="Page-content"> <article class="container"> <header><h1>上传文件这件事，蛋疼何止一点点！</h1><p><time datetime="2014-05-28 00:00:00 +0800">2014-05-28 00:00:00</time>发布</p> </header><div class="Article-content col-md-9"><p>在做 Web App 时，不可避免地要上传一些文件，最常用到的就是图片。在线相册及图片收藏网站等以提供图片存储服务的站点自不用说，社交网络的头像、发布信息等都需要上传图片的功能。提供电子邮件服务的站点，除了图片还需要上传文档等其他类型文件的功能。</p><p>如果是几年前，这种功能用最原始的 <code>&lt;form&gt;</code>（下文用「表单」指代）就能轻松地实现，只需在提交时加个遮罩层防止用户瞎点就可以了。然而，随着 web 的发展与人们审美的提高，这种简单粗暴的方式越来越不受人待见——就像在大家都懂得打扮自己时你却还灰头土脸穿得跟工地里的农民工一样——太不优雅！</p><p>表单的「挫」点主要体现在以下几个方面：</p><ol><li><p><strong>土掉渣</strong></p><p>虽然 <code>&lt;input type="file"&gt;</code>（下文用「原生上传控件」指代）在各个浏览器中的外观不甚相同，但有共同的特点——丑，并固执着！说它「固执」是因为无法通过 CSS 对其进行外观上的改造。</p></li><li><p><strong>互动性差</strong></p><p>如果是理想情况下，文件会很快传完，用户的心情会很愉快；但当遇到文件体积过大或者网速过慢的情况，在等了几分钟、十几分钟甚至是几十分钟后文件还没传完，并且不知道已经上传完多少以及大约还需多久能传完时，估计用户就该抓狂想要砸电脑了吧！</p></li><li><p><strong>不能进行其他操作</strong></p><p>表单在提交后，虽然浏览器显示的是当前页面，但地址栏中的 URL 已经改变，因为是在等待文件完全上传到服务器，所以页面暂时没有刷新。这时用户的操作行为就受到了限制，只能默默地等待文件上传结束……</p></li></ol><p>一个人长得丑，那没有办法，这是天生的，但不代表没有魅力——可以靠着装打扮、学识经历、金钱地位等弥补天生的缺陷。「上传文件」也可以像「矮穷挫」一样逆袭成为「高富帅」！至于如何逆袭，我相信每个人都有自己的见解，这里就说说我所想、我所了解的。</p><h2 class="heading" id="section">换个造型</h2><p>即使原生上传控件本身无法通过 CSS 对其进行改造，可还是有办法让它看起来很「帅」的——用口红、胭脂等化妆品将其丑陋的外表遮掩起来。</p><div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/upload_file"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span><span class="nt">&gt;</span>选择文件<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;style&gt;</span>
  <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">"file"</span><span class="o">]</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="c1">// !!! Include jQuery first</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">":button"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">":file"</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"click"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span></code></pre></div><p>当写了一个非常好看的替代原生上传控件的按钮，用以上方式通过 Chrome 或 Firefox 弹出系统对话框选择文件并成功上传到服务器后，想必会雀跃不已地夸自己一句——「我真特么是个天才！」</p><p>每实现一个新功能后必定要测试一下 IE 的兼容性。打开 IE9，重复一遍操作步骤，本来以为会正常弹出对话框的，它却——</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">SCRIPT5</span><span class="o">:</span> <span class="err">拒绝访问。</span></code></pre></div><p>「尼玛！！！有没有搞错？！IE9 居然会有问题？！话说，这个异常是什么意思啊？！问题出在哪里都没有提示！！！」——看到控制台中输出那行红色的字符串之后，估计你的内心当中有如千万匹草泥马在奔腾！</p><p>你肯定以为 IE9 会比 IE8 高级些，可事实往往是残酷的！在表单处理上，它俩都<strong>不允许利用 JavaScript 触发原生上传控件的 <code>click</code> 事件</strong>。</p><p>那怎样才能既隐藏掉原生上传控件，又弹出选择文件的系统对话框呢？</p><div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/upload_file"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span&gt;</span>选择文件<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;style&gt;</span>
  <span class="nt">form</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">inline</span><span class="o">-</span><span class="k">block</span><span class="p">;</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
    <span class="k">overflow</span><span class="o">:</span> <span class="k">hidden</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">"file"</span><span class="o">]</span> <span class="p">{</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">right</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">10em</span><span class="p">;</span>
    <span class="n">filter</span><span class="o">:</span> <span class="n">progid</span><span class="o">:</span><span class="n">DXImageTransform</span><span class="o">.</span><span class="n">Microsoft</span><span class="o">.</span><span class="n">Alpha</span><span class="p">(</span><span class="n">Opacity</span><span class="o">=</span><span class="m">0</span><span class="p">);</span>
    <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">cursor</span><span class="o">:</span> <span class="k">pointer</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span></code></pre></div><p>虽然说是「隐藏」，但只是让原生上传控件「不可见」而已，它还是妥妥地在表单中占据着空间位置。当点击所看到的「按钮」时，实际点击的是原生上传控件，这样一来就触发了浏览器默认行为，即打开选择文件对话框。</p><h2 class="heading" id="xhr-">XHR 上传</h2><h2 class="heading" id="section-1">跨域</h2></div> <footer class="col-md-3"><div class="Article-meta"><p class="Article-author"><a href="/about/" class="Author-link--withAvatar"><img src="/assets/avatars/ourai-100px-c12530e270d0aa48f4bddc067ec66ce0.jpg"></a><a href="/about/" class="Author-link">欧雷</a>发表于<br><a href="/categories/web-development/">网站开发</a></p><div id="supportAuthor"><p>如果您觉得文章内容有所帮助，请随意打赏。您的支持将鼓励作者继续创作！</p><ul><li><img src="/assets/qrcodes/pay/alipay/ourai-95f3f9a7ad63ae0b2c12ae8f7da284bb.jpg"></li><li><img src="/assets/qrcodes/pay/wechat/ourai-dbfd38193e96f087bfb12eb18df33f45.jpg"></li></ul></div><p class="Article-license">本文采用知识共享<a href="http://creativecommons.org/licenses/by-nc/3.0/cn/" target="_blank">署名-非商业性使用 3.0 中国大陆</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p><div class="Article-share social-share" data-sites="wechat,qzone,weibo,twitter"></div></div> </footer> </article><div class="Disqus container"><div class="row"><div id="disqus_thread" class="col-md-9"></div></div></div> <script>var disqus_shortname="ourairyu";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </main> <script src="/assets/pages/post-091f31369844874e6328e598bc00e825.js"></script></body></html>