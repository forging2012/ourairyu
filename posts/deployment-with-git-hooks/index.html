<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>用 Git Hooks 进行自动部署 - 欧雷流</title><meta name="description" content="不走寻常路"><link rel="author" href="http://ourai.ws/"><link rel="icon" href="/assets/favicon-d770cf1b4a3a03cd5bac1dde4e2e413f.ico"><link rel="stylesheet" href="/assets/global-7cb46e775cc6019d4125b084a83ca668.css"><link rel="stylesheet" href="/assets/pages/common-fc9758f07ee56a73cf7a62bb95734b5f.css"> <script src="/assets/global-f9109bd900850d4f4fbac70091ae986d.js"></script><!--[if lt IE 9]><script src="/assets/support_ie8-f9109bd900850d4f4fbac70091ae986d.js"></script><![endif]--></head><body itemscope itemtype="http://schema.org/WebPage"> <nav class="Page-navs"><ul><li><a href="/">首页</a></li><li><a href="/posts/">文章</a></li><li><a href="/about/">关于</a></li></ul> </nav> <header class="Page-header container sr-only"><div><h1>欧雷流</h1><p>不走寻常路</p></div> </header> <main> <article class="container"> <header><h1>用 Git Hooks 进行自动部署</h1><p><time datetime="2015-10-10 01:29:38 +0800">2015-10-10 01:29:38</time>发布</p> </header><div class="Article-content col-md-9"><p>昨天开始接手开发公司前端团队的主页，在稍微修改点东西后推送到远程仓库想看下线上结果时发现并没有更改！询问一把手得知，居然还需要连接到服务器执行一下 <code>git pull</code> 才行……对于我这种怕麻烦的人来说，简直不能忍！</p><p>经过一番查找资料以及一顿折腾，终于让它能够自动跑起来了，真是高兴得我手舞足蹈啊！</p><p>虽然弄了较长时间，在实践的过程中踩了点坑，但回过头来一看还是挺简单的。总的来说，我们需要在服务器和本机都做一下配置（这不废话么……）——</p><h2 id="section">服务器</h2><h3 id="section-1">创建仓库</h3><p>服务器上需要配置两个 git 仓库，一个用于代码版本管理的远程仓库，一个用于用户访问的本地仓库。<strong>这里的「远程仓库」并不等同于托管代码的「中央仓库」</strong>，这两个仓库都是为了自动同步代码并部署网站而存在。</p><p>在存放远程仓库的目录中（假设是 <code>/home/ourai/repos</code>）执行 <code>git init --bare bridge.git</code> 会创建一个包含 git 各种配置文件的「裸仓库」。</p><p>切换到存放用户所访问文件的目录（假设为 <code>/home/ourai/www</code>，如果不存在则在 <code>/home/ourai</code> 中执行 <code>mkdir www</code>）：</p><div class="highlight"><pre><code class="language-sh" data-lang="sh">git init
git remote add origin ~/repos/bridge.git
git fetch
git checkout master</code></pre></div><h3 id="git-hook">配置 Git Hook</h3><p>将目录切换至 <code>bridge.git/hooks</code>，用 <code>cp post-receive.sample post-receive</code> 拷贝并用 <code>vim post-receive</code> 修改。其内容大致如下：</p><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>

<span class="nb">unset </span>GIT_DIR

<span class="nv">NowPath</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nv">DeployPath</span><span class="o">=</span><span class="s2">"../../www"</span>

<span class="nb">cd</span> <span class="nv">$DeployPath</span>
git pull origin master

<span class="nb">cd</span> <span class="nv">$NowPath</span>
<span class="nb">exit </span>0</code></pre></div><p>使用 <code>chmod +x post-receive</code> 改变一下权限后，服务器端的配置就基本完成了。</p><h2 id="section-2">本机</h2><p>在原有的（托管代码的）仓库上加入刚才所配置的服务器上的远程仓库的地址为源，以后往那个源推送代码后就会自动部署了。</p></div> <footer class="col-md-3"><div class="Article-meta"><p><a href="/about/" class="Author-link--withAvatar"><img src="/assets/avatars/ourai-100px-c12530e270d0aa48f4bddc067ec66ce0.jpg"></a><a href="/about/" class="Author-link">欧雷</a>发表于<br>web-development</p><div id="supportAuthor"><p>如果您觉得文章内容有所帮助，请随意打赏。您的支持将鼓励作者继续创作！</p><ul><li><img src="/assets/qrcodes/pay/alipay/ourai-95f3f9a7ad63ae0b2c12ae8f7da284bb.jpg"></li><li><img src="/assets/qrcodes/pay/wechat/ourai-dbfd38193e96f087bfb12eb18df33f45.jpg"></li></ul></div></div> </footer> </article><div class="container"><div class="row"><div id="disqus_thread" class="col-md-9"></div></div></div> <script>var disqus_shortname="ourairyu";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </main> <script src="/assets/pages/post-62b1caf1332a98300005a4fd9dceb60c.js"></script></body></html>