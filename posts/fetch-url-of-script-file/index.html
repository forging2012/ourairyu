<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>获取 JavaScript 脚本文件路径</title> <meta property="og:title" content="获取 JavaScript 脚本文件路径"> <meta name="description" content="在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 Sea.js 等 Module Loader 就会用到。"> <meta property="og:description" content="在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 Sea.js 等 Module Loader 就会用到。"> <link rel="canonical" href="http://ourai.ws/posts/fetch-url-of-script-file/"> <meta property="og:url" content="http://ourai.ws/posts/fetch-url-of-script-file/"> <meta property="og:site_name" content="欧雷流"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "欧雷流", "url" : "http://ourai.ws" } </script> <meta property="og:type" content="article"> <meta property="article:published_time" content="2013-08-22T00:00:00+08:00"> <link rel="next" href="http://ourai.ws/posts/difficult-to-determine/" title="难以抉择"> <link rel="prev" href="http://ourai.ws/posts/self-management/" title="成为自己的「管理者」"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "获取 JavaScript 脚本文件路径", "image": null, "datePublished": "2013-08-22T00:00:00+08:00", "description": "在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 Sea.js 等 Module Loader 就会用到。" } </script> <link rel="author" href="http://ourai.ws"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <!-- 订阅 --> <link type="application/atom+xml" rel="alternate" href="http://ourai.ws/atom.xml" title="欧雷流" /> <link type="application/rss+xml" rel="alternate" href="http://ourai.ws/rss.xml" title="欧雷流"> <!-- 站点 icon --> <link rel="icon" href="/assets/favicon-3e749ca030e3b71eb2662d947c789061d2da9e0f4ee5f3360cfa9ccbe053c8ba.ico"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/global-f8df8890c111b9e191ac6c5a3e4106a852b891746130c77e5cc3ae7348d7c5d6.css"> <link type="text/css" rel="stylesheet" href="/assets/share-2811f36e337fef8021089414f657904b7e88db17d8ecade0688c8c3f5e632a5c.css"> <link type="text/css" rel="stylesheet" href="/assets/pages/post-91bc00acd467a2ac26d396fbc08fe8c0e00e06371fc8b47557c942a0ff2cb6c8.css"> <script type="text/javascript" src="/assets/statistic-1ea29c0766f94f50952bfa782205eabf2983d5612009d1e34288966dcee00da5.js"></script> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">切换导航</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a href="/" class="navbar-brand">Ourai.WS</a> </div> <!-- 导航 --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav"> <li><a href="/">首页</a></li> <li><a href="/posts/">文章</a></li> <li><a href="/about/">关于</a></li> </ul> </nav> </div> </div> </header> <main class="Page-content"> <!-- 内容主体 --> <div class="container"> <article class="Page-main Article"> <header class="Article-header"> <h1 class="Article-title">获取 JavaScript 脚本文件路径</h1> <p><a href="/about/">欧雷</a> 发表于 <time datetime="2013-08-22T00:00:00+08:00">2013-08-22 00:00:00</time></p> <div class="Article-tags"> <span>标签：</span> <ul> <li><a href="/tags/javascript/">JavaScript</a></li> <li><a href="/tags/url/">统一资源定位符</a></li> </ul> </div> </header> <div class="Article-content col-md-9"> <p>在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 <a href="http://seajs.org">Sea.js</a> 等 Module Loader 就会用到。</p> <p>目前常被用到的有以下几种方式，它们有各自的优缺点。</p> <h2 class="heading" id="script-">script 标签</h2> <p>通过获取最后一个<code>&lt;script&gt;</code>标签的<code>src</code>属性来得到脚本文件的 URL。这种方式的关键点是<strong>正在执行的语句所在的 JS 文件是“当时最后的 JS 文件”</strong>。Sea.js 中就是用的此方法。</p> <p>正因如此，瓶颈也在这里。这种方式只能在同一个文件中即时执行才有效，不能延迟执行及写成通用的 method 供其他地方调用，否则获取到的不一定是哪个 JS 文件的 URL 了。不过这种方式的优点就是能够兼容各个浏览器。</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">scripts</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">];</span>

  <span class="k">return</span> <span class="nx">script</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">?</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">:</span>
    <span class="c1">// hack for IE8-</span>
    <span class="c1">// see http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">();</span></code></pre></figure> <h2 class="heading" id="section">捕获异常</h2> <p>这是一个从<a href="http://www.cnblogs.com/rubylouvre/archive/2010/04/06/1705817.html">司徒正美的博文</a>中看到的较为“聪明”的方法，利用了 exception 信息中会带有出错文件及位置的特点来获取。</p> <p>这种方式可以写为一个通用的 method，但其还是有两个较为严重的缺陷：</p> <ol> <li>兼容性差，IE 和 Opera 基本都被排挤在外</li> <li>在调用时必须在回调函数中抛出异常</li> </ol> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">(</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Firefox</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Safari</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Opera 9</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/\(\) in\s+(.*?\:\/\/\S+)/m</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="c1">// Chrome 4+/IE 10+</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/((http|file)\:\/{2,3}\S+\/\S+\.[a-z0-9]+)/i</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// must throw an exception</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span> <span class="s2">&quot;WTF!!!&quot;</span> <span class="p">);</span>
    <span class="p">});</span></code></pre></figure> </div> <footer class="Article-footer col-md-3"> <div class="Widget Article-category"> <div class="Widget-body"> <p>发布在</p> <div> <h3><a href="/categories/web-development/">网站开发</a></h3> <p>利用网页程序语言等技术进行网站和网络应用的开发与维护</p> </div> </div> </div> <div class="Widget Article-license"> <div class="Widget-body"> <p>本文采用知识共享<i class="fa fa-creative-commons"></i><a href="http://creativecommons.org/licenses/by-nc/3.0/cn/" target="_blank">署名-非商业性使用 3.0 中国大陆</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p> </div> </div> <div class="Widget Widget--share"> <div class="Widget-body"> <p>分享到<i class="fa fa-share-alt"></i></p> <div class="social-share" data-sites="wechat,qzone,weibo,twitter"></div> </div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> <div class="Article-comments col-md-9"><div id="disqus_thread"></div> <script type="text/javascript"> /* * * CONFIGURATION VARIABLES * * */ var disqus_shortname = 'ourairyu'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </article> </div> </main> <footer class="Page-footer Footer"> <div class="container"> <p class="Footer-copyright">&copy; 2009-2016 <a href="/">欧雷流</a> 版权所有</p> <p class="Footer-support">本站采用 <a href="http://jekyllrb.com" rel="external nofollow" target="_blank">Jekyll</a> 生成并托管于 <a href="https://github.com/ourai/ourai.github.io" rel="external nofollow" target="_blank">GitHub</a> | 主题由<a href="/about/">欧雷</a>设计开发（版本：v4.3.5） <a href="http://validator.w3.org/check?uri=referer" target="_blank" rel="external nofollow" class="fa fa-html5"></a> <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" target="_blank" rel="external nofollow" class="fa fa-css3"></a></p> </div> </footer> <script type="text/javascript" src="/assets/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/components-7717a5876dfdf1fb3add240a18a3b340cd18af830719f564d25115155f5f7592.js"></script> <script type="text/javascript" src="/assets/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script> </body> </html>
