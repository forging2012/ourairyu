<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head><base href="/dev/"><meta charset="UTF-8"><title>获取 JavaScript 脚本文件路径 - 网道</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="keywords" content="欧雷,欧雷流,宅男的部屋,宅男部屋,宅男,ourai,ourairyu,developer,center,dev,network,front-end,web,网络开发,web开发,开发网络,开发中心"><link rel="author" href="https://plus.google.com/110971881899489153670/"><link rel="shortcut icon" href="images/favicon.ico"><link rel="stylesheet" href="stylesheets/matcha.min.css"><link rel="stylesheet" href="stylesheets/highlight.css"><link rel="stylesheet" href="stylesheets/site.css"><link rel="stylesheet" href="stylesheets/highlight.css"><link rel="stylesheet" href="stylesheets/pages/article.css"> <!--[if lt IE 8]><link rel="stylesheet" href="stylesheets/forbid.css"><![endif]--><!--[if lt IE 9]><script src="javascripts/html5shiv-printshiv.min.js"></script><![endif]--><script src="javascripts/jquery.min.js"></script><script src="javascripts/tatami.min.js"></script><script src="javascripts/matcha.min.js"></script></head><body itemscope itemtype="http://schema.org/WebPage" class="layout--sandwich" data-layout="article" data-page="none"><header class="layout-header"> <nav class="layout-nav layout-inner"><ul><li><a href="/">首页</a></li><li><a href="/projects/">项目</a></li></ul> </nav> </header><main class="layout-container"><div class="layout-content layout-inner"> <article class="article" itemscope itemtype="http://schema.org/Article"> <header class="article-header"><div class="article-title"><h1 itemprop="name">获取 JavaScript 脚本文件路径</h1></div><div class="article-meta"> <time datetime="2013-08-22" itemprop="datePublished">Aug 22, 2013</time> JavaScript | URL</div> </header><div class="article-body" itemprop="articleBody"><p>在开发过程中，有时需要动态获取文件的 URL，获取 JS 文件的 URL 是最常见的需求，例如像 <a href="http://seajs.org">Sea.js</a> 等 Module Loader 就会用到。</p><p>目前常被用到的有以下几种方式，它们有各自的优缺点。</p><h2 class="heading" id="script-">script 标签</h2><p>通过获取最后一个<code>&lt;script&gt;</code>标签的<code>src</code>属性来得到脚本文件的 URL。这种方式的关键点是<strong>正在执行的语句所在的 JS 文件是“当时最后的 JS 文件”</strong>。Sea.js 中就是用的此方法。</p><p>正因如此，瓶颈也在这里。这种方式只能在同一个文件中即时执行才有效，不能延迟执行及写成通用的 method 供其他地方调用，否则获取到的不一定是哪个 JS 文件的 URL 了。不过这种方式的优点就是能够兼容各个浏览器。</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">scripts</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">];</span>

  <span class="k">return</span> <span class="nx">script</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">?</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">:</span>
    <span class="c1">// hack for IE8-</span>
    <span class="c1">// see http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span> <span class="s2">"src"</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">();</span></code></pre></div><h2 class="heading" id="section">捕获异常</h2><p>这是一个从<a href="http://www.cnblogs.com/rubylouvre/archive/2010/04/06/1705817.html">司徒正美的博文</a>中看到的较为“聪明”的方法，利用了 exception 信息中会带有出错文件及位置的特点来获取。</p><p>这种方式可以写为一个通用的 method，但其还是有两个较为严重的缺陷：</p><ol><li>兼容性差，IE 和 Opera 基本都被排挤在外</li><li>在调用时必须在回调函数中抛出异常</li></ol><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">scriptPath</span><span class="p">(</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">"function"</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Firefox</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">fileName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Safari</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceURL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Opera 9</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stacktrace</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/\(\) in\s+(.*?\:\/\/\S+)/m</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="c1">// Chrome 4+/IE 10+</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/((http|file)\:\/{2,3}\S+\/\S+\.[a-z0-9]+)/i</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span><span class="s1">''</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// must throw an exception</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">scriptPath</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span> <span class="s2">"WTF!!!"</span> <span class="p">);</span>
    <span class="p">});</span></code></pre></div></div> <footer class="article-footer"><div class="article-switcher"> <a href="/posts/how-to-improve-web-page-performance/" class="prev_article" title="网站性能优化·前端篇">网站性能优化·前端篇</a> <a href="/posts/definition-list-with-dl/" class="next_article" title="用 DL 标签实现信息列表">用 DL 标签实现信息列表</a></div><ul class="related_articles"><li><a href="/posts/how-to-improve-web-page-performance/" title="网站性能优化·前端篇">网站性能优化·前端篇</a></li><li><a href="/posts/definition-list-with-dl/" title="用 DL 标签实现信息列表">用 DL 标签实现信息列表</a></li><li><a href="/posts/passing-parameters-between-pages-implicitly/" title="页面间隐式传递参数">页面间隐式传递参数</a></li><li><a href="/posts/ie-block-level-element-height-not-zero/" title="IE6、IE7 及 IE8 怪癖模式下空块级非替换元素高度不为 0">IE6、IE7 及 IE8 怪癖模式下空块级非替换元素高度不为 0</a></li><li><a href="/posts/container-margin-collapse/" title="容器与内部元素外边距重叠">容器与内部元素外边距重叠</a></li><li><a href="/posts/php-access-data-messy-code/" title="php 读取数据中文乱码解决方案">php 读取数据中文乱码解决方案</a></li><li><a href="/posts/horizontal-round-corner-menu/" title="圆角横向菜单实现技巧">圆角横向菜单实现技巧</a></li></ul> </footer> </article><div id="disqus_thread"></div> <script>var disqus_shortname="ouraidev";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div> </main> <footer class="layout-footer"><div class="layout-inner"><div class="footer-links"><div class="internal"> <b>内部通道</b><ul><li><a href="/about/">关于本站</a></li><li><a href="/links/">外部链接</a></li></ul></div><div class="other"> <b>狡兔三窟</b><ul><li><a href="http://ourai.ws/" target="_blank" rel="external nofollow">欧雷流</a></li><li><a href="https://github.com/ourai" target="_blank" rel="external nofollow">GitHub</a></li><li><a href="https://www.codewars.com/users/ourai" target="_blank" rel="external nofollow">Codewars</a></li><li><a href="http://segmentfault.com/u/ourai" target="_blank" rel="external nofollow">SegmentFault</a></li><li><a href="http://weibo.com/ourairyu" target="_blank" rel="external nofollow">微博</a></li></ul></div></div><p class="w3c_techs"><a href="http://validator.w3.org/check?uri=referer" target="_blank" rel="external nofollow"><img src="http://www.w3.org/html/logo/badge/html5-badge-h-css3-semantics.png" width="165" height="64" alt="HTML5 Powered with CSS3 / Styling, and Semantics" title="HTML5 Powered with CSS3 / Styling, and Semantics"></a></p><div class="profile" itemscope itemtype="http://schema.org/Person" lang="en"> <a href="http://lin.ourai.ws/" class="avatar_link" target="_blank" rel="external nofollow"><img class="avatar" src="/images/avatars/mask_2d.jpg?s=120" itemprop="image" alt="欧雷"></a><div class="profile_info"><h3 class="author"><a href="http://lin.ourai.ws/" class="author_link" itemprop="name" target="_blank" rel="external nofollow">Ourai Lin</a></h3><p>Developer / Blogger</p></div></div><p class="copyright">Copyright © 2011-2015 <a href="http://ourai.ws/" target="_blank" rel="external nofollow" title="欧雷流">Ourai.WS</a></p><p class="dependencies">Powered by <a href="https://github.com/" target="_blank" rel="external nofollow" title="GitHub is the best place to share code with friends, co-workers, classmates, and complete strangers. Over four million people use GitHub to build amazing things together.">GitHub</a>, <a href="http://jekyllrb.com/" target="_blank" rel="external nofollow" title="Jekyll is a simple, blog-aware, static site generator. It takes a template directory containing raw text files in various formats, runs it through Markdown (or Textile) and Liquid converters, and spits out a complete, ready-to-publish static website suitable for serving with your favorite web server.">Jekyll</a>, <a href="http://disqus.com/" target="_blank" rel="external nofollow" title="Disqus is a free service that enables great online communities. As the web’s most popular discussion system, Disqus is used by millions of websites that cover pretty much any topic imaginable. Its magic is in connecting people to stuff worth talking about.">Disqus</a></p></div> </footer><script>Tatami.sandbox()</script><!--[if lt IE 8]><div class="forbidden_message"><p>很抱歉，本站不支持低于 Internet Explorer 8 的浏览器。</p><p>如果您想继续用 Internet Explorer 浏览器访问本站，请先<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">升级</a>。</p></div><![endif]--></body></html>