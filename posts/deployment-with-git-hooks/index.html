<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>用 Git Hooks 进行自动部署 - 欧雷流</title><meta name="description" content="不走寻常路"><link type="application/atom+xml" rel="alternate" href="http://ourai.ws/atom.xml" title="欧雷流"/><link rel="author" href="http://ourai.ws/"><link rel="icon" href="/assets/favicon-d770cf1b4a3a03cd5bac1dde4e2e413f.ico"><link rel="stylesheet" href="/assets/global-a600a3b8cf7b3ebf5f2e38a52e0189a2.css"><link rel="stylesheet" href="/assets/share-56a633c78644feaa49a3df0449290af5.css"><link rel="stylesheet" href="/assets/pages/common-bbec6abc886327b6c805887c34141a54.css"> <script src="/assets/global-6d5e42c77c3a921431d6341f6f4e7f96.js"></script><!--[if lt IE 9]><script src="/assets/support_ie8-f9109bd900850d4f4fbac70091ae986d.js"></script><![endif]--></head><body class="Page" itemscope itemtype="http://schema.org/WebPage"> <nav class="Page-navs"><ul><li><a href="/">首页</a></li><li><a href="/posts/">文章</a></li><li><a href="/about/">关于</a></li></ul> </nav> <header class="Page-header container sr-only"><div><h1>欧雷流</h1><p>不走寻常路</p></div> </header> <main class="Page-content"> <article class="container"> <header><h1>用 Git Hooks 进行自动部署</h1><p><time datetime="2015-10-10 01:29:38 +0800">2015-10-10 01:29:38</time>发布</p> </header><div class="Article-content col-md-9"><p>昨天开始接手开发公司前端团队的主页，在稍微修改点东西后推送到远程仓库想看下线上结果时发现并没有更改！询问一把手得知，居然还需要连接到服务器执行一下 <code>git pull</code> 才行……对于我这种怕麻烦的人来说，简直不能忍！</p><p>经过一番查找资料以及一顿折腾，终于让它能够自动跑起来了，真是高兴得我手舞足蹈啊！虽然弄了较长时间，在实践的过程中踩了点坑，但回过头来一看还是挺简单的。总的来说，就只是在服务器和本机都做一下配置。（这不废话么……）</p><p>由于公司的服务器是 CentOS，我所使用的电脑是 Mac OS X，故本文内容是基于这两个系统环境所写。GUI 在给用户带来很多便利的同时也隐藏了一些不便，如：需要下载应用软件及在操作界面交互。鉴于本文的中心是「自动化」，所以一切操作都采用命令行——</p> <section><h2>远程连接服务器</h2><p>在搭建环境的整个过程中，有很多步骤是需要连接到服务器进行的，然而在每次访问的时候都需要输入用户名和密码，就像逢年过节回家聚会都会被亲戚朋友询问「什么时候结婚呀」「何时抱小孩啊」。这就是为什么要把这步放到前面——在自己脑门上写上计划的结婚生子时间，省得他们总问！</p><h3>生成 SSH 密钥</h3><p>密钥是免登录连接服务器的通行证，有种刷脸通行的感觉。<b>如果本地已经存在并且不想另外生成的话，可以跳过此步。</b></p><p><code>cd ~/.ssh</code> 切换目录后用 <code>ssh-keygen -t rsa -C "用于区分密钥的标识"</code> 生成一对具有相同名字的密钥（默认为 <code>id_rsa</code> 和 <code>id_rsa.pub</code>）：用于本地的私钥和用于服务器的公钥（有 <code>.pub</code> 扩展名）。</p><p>如果私钥名字不是默认的话，需要手动加入到被「认证」的私钥列表中，否则每次连接服务器都会提示输入服务器的密码。在遇到了一些坑（文后有说明）后，我觉得设置 SSH config 最为靠谱！</p><p>编辑 <code>~/.ssh/config</code> 文件（如果不存在则 <code>touch ~/.ssh/config</code> 创建一下），添加以下内容：</p><div class="highlight"><pre><code class="language-sh" data-lang="sh">Host HOST_ALIAS                       <span class="c"># 用于 SSH 连接的别名，最好与 HostName 保持一致</span>
  HostName SERVER_DOMAIN              <span class="c"># 服务器的域名或 IP 地址</span>
  Port SERVER_PORT                    <span class="c"># 服务器的端口号，默认为 22，可选</span>
  User SERVER_USER                    <span class="c"># 服务器的用户名</span>
  PreferredAuthentications publickey
  IdentityFile ~/.ssh/PRIVATE_KEY     <span class="c"># 本机上存放的私钥路径</span></code></pre></div><h3>服务器端认证</h3><p>先用 <code>pbcopy &lt; ~/.ssh/PRIVATE_KEY.pub</code> 将公钥复制到剪贴板；通过 <code>ssh USER@SERVER</code> 访问服务器，这时会提示输入密码（它也许只有这么一次「询问」的机会）；成功登录后 <code>vim ~/.ssh/authorized_keys</code>，在合适的位置 <kbd>cmd</kbd> + <kbd>V</kbd> 并保存退出（同时 <code>exit</code> 退出 SSH 连接）。</p> </section> <section><h2>配置 Git 仓库</h2><h3>创建服务器端仓库</h3><p>服务器上需要配置两个仓库，一个用于代码中转的远程仓库，一个用于用户访问的本地仓库。**这里的「远程仓库」并不等同于托管代码的「中央仓库」**，这两个仓库都是为了自动同步代码并部署网站而存在。</p><p>在存放远程仓库的目录中（假设是 <code>/home/USER/repos</code>）执行 <code>git init --bare BRIDGE_REPO.git</code> 会创建一个包含 Git 各种配置文件的「裸仓库」。</p><p>切换到存放用户所访问文件的目录（假设为 <code>/home/USER/www</code>，如果不存在则在 <code>/home/USER</code> 中执行 <code>mkdir www</code>）：</p><div class="highlight"><pre><code class="language-sh" data-lang="sh">git init
git remote add origin ~/repos/BRIDGE_REPO.git
git fetch
git checkout master</code></pre></div><h3>配置 Git Hook</h3><p>将目录切换至 <code>/home/USER/repos/BRIDGE_REPO.git/hooks</code>，用 <code>cp post-receive.sample post-receive</code> 复制并重命名文件后用 <code>vim post-receive</code> 修改。其内容大致如下：</p><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>

<span class="nb">unset </span>GIT_DIR

<span class="nv">NowPath</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nv">DeployPath</span><span class="o">=</span><span class="s2">"../../www"</span>

<span class="nb">cd</span> <span class="nv">$DeployPath</span>
git pull origin master

<span class="nb">cd</span> <span class="nv">$NowPath</span>
<span class="nb">exit </span>0</code></pre></div><p>使用 <code>chmod +x post-receive</code> 改变一下权限后，服务器端的配置就基本完成了。</p><h3>更新本机的仓库源</h3><p>在原有的（托管代码的）仓库上加入刚才所配置的服务器上的远程仓库的地址为源，以后往那个源推送代码后就会自动部署了。</p> </section> <section><h2>总结</h2><p>在搭建环境时并没有一帆风顺，磕磕绊绊遇到不少问题，虽然很多不值得一提，但有的点还是有记录并分享的价值的！</p><h3>SSH 私钥「认证」</h3><p><a href="http://segmentfault.com/q/1010000000835302/a-1020000000883441" target="_blank">将生成的私钥进行「认证」有不止一种方式</a>，然而，起初我用的是最挫最不靠谱的 <code>ssh-add ~/.ssh/PRIVATE_KEY</code>——只是在当前 session 有效，一重启就又会被「询问」了！</p> </section></div> <footer class="col-md-3"><div class="Article-meta"><p class="Article-author"><a href="/about/" class="Author-link--withAvatar"><img src="/assets/avatars/ourai-100px-c12530e270d0aa48f4bddc067ec66ce0.jpg"></a><a href="/about/" class="Author-link">欧雷</a>发表于<br><a href="/categories/web-development/">网站开发</a></p><div id="supportAuthor"><p>如果您觉得文章内容有所帮助，请随意打赏。您的支持将鼓励作者继续创作！</p><ul><li><img src="/assets/qrcodes/pay/alipay/ourai-95f3f9a7ad63ae0b2c12ae8f7da284bb.jpg"></li><li><img src="/assets/qrcodes/pay/wechat/ourai-dbfd38193e96f087bfb12eb18df33f45.jpg"></li></ul></div><p class="Article-license">本文采用知识共享<a href="http://creativecommons.org/licenses/by-nc/3.0/cn/" target="_blank">署名-非商业性使用 3.0 中国大陆</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p><div class="Article-share social-share" data-sites="wechat,qzone,weibo,twitter"></div></div> </footer> </article><div class="Disqus container"><div class="row"><div id="disqus_thread" class="col-md-9"></div></div></div> <script>var disqus_shortname="ourairyu";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </main> <script src="/assets/pages/post-091f31369844874e6328e598bc00e825.js"></script></body></html>