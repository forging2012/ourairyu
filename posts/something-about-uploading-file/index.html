<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>上传文件这件事，蛋疼何止一点点！</title> <meta property="og:title" content="上传文件这件事，蛋疼何止一点点！"> <meta name="description" content="在做 Web App 时，不可避免地要上传一些文件，最常用到的就是图片。在线相册及图片收藏网站等以提供图片存储服务的站点自不用说，社交网络的头像、发布信息等都需要上传图片的功能。提供电子邮件服务的站点，除了图片还需要上传文档等其他类型文件的功能。"> <meta property="og:description" content="在做 Web App 时，不可避免地要上传一些文件，最常用到的就是图片。在线相册及图片收藏网站等以提供图片存储服务的站点自不用说，社交网络的头像、发布信息等都需要上传图片的功能。提供电子邮件服务的站点，除了图片还需要上传文档等其他类型文件的功能。"> <link rel="canonical" href="http://ourai.ws/posts/something-about-uploading-file/"> <meta property="og:url" content="http://ourai.ws/posts/something-about-uploading-file/"> <meta property="og:site_name" content="欧雷流"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "欧雷流", "url" : "http://ourai.ws" } </script> <meta property="og:type" content="article"> <meta property="article:published_time" content="2014-05-28T00:00:00+08:00"> <link rel="next" href="http://ourai.ws/posts/dream/" title="梦想"> <link rel="prev" href="http://ourai.ws/posts/limited-youth/" title="青春有限"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "上传文件这件事，蛋疼何止一点点！", "image": null, "datePublished": "2014-05-28T00:00:00+08:00", "description": "在做 Web App 时，不可避免地要上传一些文件，最常用到的就是图片。在线相册及图片收藏网站等以提供图片存储服务的站点自不用说，社交网络的头像、发布信息等都需要上传图片的功能。提供电子邮件服务的站点，除了图片还需要上传文档等其他类型文件的功能。" } </script> <link rel="author" href="http://ourai.ws"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <!-- 订阅 --> <link type="application/atom+xml" rel="alternate" href="http://ourai.ws/atom.xml" title="欧雷流" /> <link type="application/rss+xml" rel="alternate" href="http://ourai.ws/rss.xml" title="欧雷流"> <!-- 站点 icon --> <link rel="icon" href="/assets/favicon-3e749ca030e3b71eb2662d947c789061d2da9e0f4ee5f3360cfa9ccbe053c8ba.ico"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/global-3c05c2fa8ad059712fd2a8e5a793045501c248299bd16c39165ab0ccbd0db2c5.css"> <link type="text/css" rel="stylesheet" href="/assets/share-2811f36e337fef8021089414f657904b7e88db17d8ecade0688c8c3f5e632a5c.css"> <link type="text/css" rel="stylesheet" href="/assets/pages/post-475ce5325eebd68091817fa745032243690d8b78c4cb8bc7fb135e7e51a13fbb.css"> <script type="text/javascript" src="/assets/statistic-ae0fea4509b55747b1bcc6318c58abf5817e03e26505a307f438b42f0c6783bc.js"></script> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">切换导航</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a href="/" class="navbar-brand">Ourai.WS</a> <aside class="Ad Ad--hire hidden-xs"><a href="/we-need-you/"><span>买好车</span><span>招聘前端开发</span></a></aside> </div> <!-- 导航 --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav"> <li><a href="/">首页</a></li> <li><a href="/posts/">文章</a></li> <li><a href="/about/">关于</a></li> </ul> </nav> </div> </div> </header> <main class="Page-content"> <!-- 内容主体 --> <div class="container"> <article class="Page-main Article"> <header class="Article-header"> <h1 class="Article-title">上传文件这件事，蛋疼何止一点点！</h1> <p><a href="/about/">欧雷</a> 发表于 <time datetime="2014-05-28T00:00:00+08:00">2014-05-28 00:00:00</time></p> <div class="Article-tags hidden-xs"> <span>标签：</span> <ul> <li><a href="/tags/html/">超文本标记语言</a></li> <li><a href="/tags/javascript/">JavaScript</a></li> <li><a href="/tags/xhr/">XML HTTP 请求</a></li> <li><a href="/tags/ajax/">AJAX</a></li> </ul> </div> </header> <div class="Article-content col-md-9"> <p>在做 Web App 时，不可避免地要上传一些文件，最常用到的就是图片。在线相册及图片收藏网站等以提供图片存储服务的站点自不用说，社交网络的头像、发布信息等都需要上传图片的功能。提供电子邮件服务的站点，除了图片还需要上传文档等其他类型文件的功能。</p> <p>如果是几年前，这种功能用最原始的 <code>&lt;form&gt;</code>（下文用「表单」指代）就能轻松地实现，只需在提交时加个遮罩层防止用户瞎点就可以了。然而，随着 web 的发展与人们审美的提高，这种简单粗暴的方式越来越不受人待见——就像在大家都懂得打扮自己时你却还灰头土脸穿得跟工地里的农民工一样——太不优雅！</p> <p>表单的「挫」点主要体现在以下几个方面：</p> <ol> <li> <p><strong>土掉渣</strong></p> <p>虽然 <code>&lt;input type="file"&gt;</code>（下文用「原生上传控件」指代）在各个浏览器中的外观不甚相同，但有共同的特点——丑，并固执着！说它「固执」是因为无法通过 CSS 对其进行外观上的改造。</p> </li> <li> <p><strong>互动性差</strong></p> <p>如果是理想情况下，文件会很快传完，用户的心情会很愉快；但当遇到文件体积过大或者网速过慢的情况，在等了几分钟、十几分钟甚至是几十分钟后文件还没传完，并且不知道已经上传完多少以及大约还需多久能传完时，估计用户就该抓狂想要砸电脑了吧！</p> </li> <li> <p><strong>不能进行其他操作</strong></p> <p>表单在提交后，虽然浏览器显示的是当前页面，但地址栏中的 URL 已经改变，因为是在等待文件完全上传到服务器，所以页面暂时没有刷新。这时用户的操作行为就受到了限制，只能默默地等待文件上传结束……</p> </li> </ol> <p>一个人长得丑，那没有办法，这是天生的，但不代表没有魅力——可以靠着装打扮、学识经历、金钱地位等弥补天生的缺陷。「上传文件」也可以像「矮穷挫」一样逆袭成为「高富帅」！至于如何逆袭，我相信每个人都有自己的见解，这里就说说我所想、我所了解的。</p> <h2 class="heading" id="section">换个造型</h2> <p>即使原生上传控件本身无法通过 CSS 对其进行改造，可还是有办法让它看起来很「帅」的——用口红、胭脂等化妆品将其丑陋的外表遮掩起来。</p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/upload_file&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span><span class="nt">&gt;</span>选择文件<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;style&gt;</span>
  <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="o">]</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="c1">// !!! Include jQuery first</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:button&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:file&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span></code></pre></figure> <p>当写了一个非常好看的替代原生上传控件的按钮，用以上方式通过 Chrome 或 Firefox 弹出系统对话框选择文件并成功上传到服务器后，想必会雀跃不已地夸自己一句——「我真特么是个天才！」</p> <p>每实现一个新功能后必定要测试一下 IE 的兼容性。打开 IE9，重复一遍操作步骤，本来以为会正常弹出对话框的，它却——</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">SCRIPT5</span><span class="o">:</span> <span class="err">拒绝访问。</span></code></pre></figure> <p>「尼玛！！！有没有搞错？！IE9 居然会有问题？！话说，这个异常是什么意思啊？！问题出在哪里都没有提示！！！」——看到控制台中输出那行红色的字符串之后，估计你的内心当中有如千万匹草泥马在奔腾！</p> <p>你肯定以为 IE9 会比 IE8 高级些，可事实往往是残酷的！在表单处理上，它俩都<strong>不允许利用 JavaScript 触发原生上传控件的 <code>click</code> 事件</strong>。</p> <p>那怎样才能既隐藏掉原生上传控件，又弹出选择文件的系统对话框呢？</p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/upload_file&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span&gt;</span>选择文件<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;style&gt;</span>
  <span class="nt">form</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">inline</span><span class="o">-</span><span class="k">block</span><span class="p">;</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
    <span class="k">overflow</span><span class="o">:</span> <span class="k">hidden</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="o">]</span> <span class="p">{</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">right</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">10em</span><span class="p">;</span>
    <span class="n">filter</span><span class="o">:</span> <span class="n">progid</span><span class="o">:</span><span class="n">DXImageTransform</span><span class="o">.</span><span class="n">Microsoft</span><span class="o">.</span><span class="n">Alpha</span><span class="p">(</span><span class="n">Opacity</span><span class="o">=</span><span class="m">0</span><span class="p">);</span>
    <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">cursor</span><span class="o">:</span> <span class="k">pointer</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span></code></pre></figure> <p>虽然说是「隐藏」，但只是让原生上传控件「不可见」而已，它还是妥妥地在表单中占据着空间位置。当点击所看到的「按钮」时，实际点击的是原生上传控件，这样一来就触发了浏览器默认行为，即打开选择文件对话框。</p> <h2 class="heading" id="xhr-">XHR 上传</h2> <h2 class="heading" id="section-1">跨域</h2> </div> <footer class="Article-footer col-md-3"> <div class="Widget Article-category"> <div class="Widget-body"> <p><i class="fa fa-pencil"></i>发布在</p> <div> <h3><a href="/categories/web-development/">网站开发</a></h3> <p>利用网页程序语言等技术进行网站和网络应用的开发与维护</p> </div> </div> </div> <div class="Widget Article-author"> <div class="Widget-body Author"> <h3 class="Author-name"><a href="/about/">欧雷</a> <a href="https://twitter.com/ourairyu" target="_blank" rel="external nofollow" class="Author-twitter">@ourairyu</a></h3> <p class="Author-intro">日本深度中毒的<strong>新四有青年</strong>、<span lang="en">C<i class="fa fa-coffee"></i>ffee L<i class="fa fa-heart"></i>ver</span>，现于<a href="https://www.maihaoche.com" target="_blank" rel="external nofollow" class="Link Link--maihaoche">买好车</a>任<strong>前端工程师</strong>一职。</p> </div> </div> <div class="Widget Article-license"> <div class="Widget-body"> <p>本文采用知识共享<i class="fa fa-creative-commons"></i><a href="http://creativecommons.org/licenses/by-nc/3.0/cn/" target="_blank">署名-非商业性使用 3.0 中国大陆</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p> </div> </div> <div class="Widget Widget--share"> <div class="Widget-body"> <p>分享到<i class="fa fa-share-alt"></i></p> <div class="social-share" data-sites="wechat,qzone,weibo,twitter"></div> </div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> <div class="Article-comments col-md-9"><div id="disqus_thread"></div> <script type="text/javascript"> /* * * CONFIGURATION VARIABLES * * */ var disqus_shortname = 'ourairyu'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </article> </div> </main> <footer class="Page-footer Footer"> <div class="container"> <!-- 网站版权 --> <div class="Footer-copyright"> <p>&copy; 2009-2016 <a href="/">欧雷流</a> 版权所有</p> </div> <!-- 技术支持 --> <div class="Footer-support"> <p>本站采用 <a href="http://jekyllrb.com" rel="external nofollow" target="_blank">Jekyll</a> 生成并托管于 <a href="https://github.com/ourai/ourai.github.io" rel="external nofollow" target="_blank">GitHub</a></p> <p class="hidden-xs">站点版本为 v4.3.9</p> <p class="hidden-xs hidden-sm"><a href="http://validator.w3.org/check?uri=referer" target="_blank" rel="external nofollow" class="fa fa-html5"></a> <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" target="_blank" rel="external nofollow" class="fa fa-css3"></a></p> </div> </div> </footer> <script type="text/javascript" src="/assets/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/components-7717a5876dfdf1fb3add240a18a3b340cd18af830719f564d25115155f5f7592.js"></script> <script type="text/javascript" src="/assets/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script> </body> </html>
